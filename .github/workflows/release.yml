name: Build and Release Provider

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'examples/**'

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          if [[ "$COMMIT_MSG" =~ ^BUILD: ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… Build triggered by commit message"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping build - commit message doesn't start with 'BUILD:'"
          fi

      - name: Extract version from commit message
        id: extract
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          VERSION=$(echo "$COMMIT_MSG" | sed -n 's/^BUILD: *v*\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          if [ -z "$VERSION" ]; then
            VERSION="0.1.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

  build:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Provider
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.check-trigger.outputs.version }}"
          
          go mod download
          go build -o terraform-provider-opnsense_v${VERSION} \
            -ldflags="-s -w -X main.version=$VERSION" \
            -trimpath
          
          mkdir -p dist
          
          # Package as ZIP for all platforms (Terraform Registry requirement)
          if [ "${{ matrix.goos }}" = "windows" ]; then
            mv terraform-provider-opnsense_v${VERSION} terraform-provider-opnsense_v${VERSION}.exe
            zip "dist/terraform-provider-opnsense_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}.zip" \
              terraform-provider-opnsense_v${VERSION}.exe
          else
            zip "dist/terraform-provider-opnsense_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}.zip" \
              terraform-provider-opnsense_v${VERSION}
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-provider-opnsense-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 30

  release:
    needs: [check-trigger, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Copy all binaries
          find artifacts -type f -name "*.zip" -exec cp {} release/ \;
          
          # Generate combined SHA256SUMS
          cd release
          sha256sum terraform-provider-opnsense_*.zip > terraform-provider-opnsense_${{ needs.check-trigger.outputs.version }}_SHA256SUMS
          
          echo "ðŸ“¦ Release files:"
          ls -lah

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Sign checksums (BINARY format for Terraform Registry)
        run: |
          cd release
          VERSION="${{ needs.check-trigger.outputs.version }}"
          SHASUMS_FILE="terraform-provider-opnsense_${VERSION}_SHA256SUMS"
          
          if [ ! -f "${SHASUMS_FILE}" ]; then
            echo "âŒ Error: ${SHASUMS_FILE} not found"
            ls -la
            exit 1
          fi
          
          echo "ðŸ“ Signing ${SHASUMS_FILE}..."
          echo "File contents:"
          cat "${SHASUMS_FILE}"
          echo ""
          
          # Get the key ID
          KEY_ID=$(gpg --list-secret-keys --keyid-format=long | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "ðŸ”‘ Using GPG key: $KEY_ID"
          echo ""
          
          # CRITICAL: Sign WITHOUT --armor to create BINARY signature
          # Terraform Registry requires binary, NOT ASCII-armored!
          echo "ðŸ“ Creating BINARY signature (required by Terraform Registry)..."
          gpg --batch --yes --pinentry-mode loopback \
            --detach-sign \
            --local-user "$KEY_ID" \
            "${SHASUMS_FILE}"
          
          # Verify signature was created
          if [ ! -f "${SHASUMS_FILE}.sig" ]; then
            echo "âŒ Error: Signature file not created"
            exit 1
          fi
          
          # Verify it's BINARY format
          echo ""
          echo "ðŸ” Checking signature format..."
          file "${SHASUMS_FILE}.sig"
          if file "${SHASUMS_FILE}.sig" | grep -q "ASCII"; then
            echo "âŒ ERROR: Signature is ASCII armored!"
            echo "Terraform Registry requires BINARY signatures!"
            exit 1
          fi
          echo "âœ… Signature is in binary format (correct for Terraform Registry)"
          echo ""
          
          # Verify the signature works
          echo "ðŸ” Verifying signature..."
          gpg --verify "${SHASUMS_FILE}.sig" "${SHASUMS_FILE}"
          echo ""
          
          echo "âœ… Checksums signed successfully"
          ls -lah "${SHASUMS_FILE}"*

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.check-trigger.outputs.version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B | tail -n +2)
          
          cat > release-notes.md << EOF
          # Terraform Provider for OPNsense v${VERSION}
          
          ## ðŸ“¦ Release Information
          
          **Version:** ${VERSION}
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** $(git rev-parse --short HEAD)
          
          ## ðŸ“ Changes
          
          ${COMMIT_MSG}
          
          ## ðŸš€ Installation
          
          ### Terraform Registry
          
          \`\`\`hcl
          terraform {
            required_providers {
              opnsense = {
                source  = "rgcosta7/opnsense"
                version = "~> ${VERSION}"
              }
            }
          }
          
          provider "opnsense" {
            host       = "https://your-opnsense.local"
            api_key    = var.opnsense_api_key
            api_secret = var.opnsense_api_secret
          }
          \`\`\`
          
          ### Manual Installation
          
          \`\`\`bash
          # Download for your platform
          # Linux AMD64
          wget https://github.com/rgcosta7/terraform-provider-opnsense-26/releases/download/v${VERSION}/terraform-provider-opnsense_${VERSION}_linux_amd64.zip
          unzip terraform-provider-opnsense_${VERSION}_linux_amd64.zip
          mkdir -p ~/.terraform.d/plugins/registry.terraform.io/rgcosta7/opnsense/${VERSION}/linux_amd64/
          mv terraform-provider-opnsense_v${VERSION} ~/.terraform.d/plugins/registry.terraform.io/rgcosta7/opnsense/${VERSION}/linux_amd64/
          \`\`\`
          
          ## ðŸ“š Resources
          
          - **Firewall:** Rules, Aliases, Categories
          - **DHCP (Kea):** Subnets and Reservations
          - **NAT:** Destination NAT (Port Forwarding)
          - **VPN:** WireGuard Servers and Peers
          
          ## âœ¨ Features
          
          - Complete firewall rule management
          - Rule categories with color coding
          - Policy-based routing (gateway selection)
          - DHCP subnet management with options
          - Static IP reservations
          - Alias support (IP/network/port groups)
          
          ## ðŸ” Verification
          
          \`\`\`bash
          # Verify checksums
          sha256sum -c terraform-provider-opnsense_${VERSION}_SHA256SUMS
          
          # Verify GPG signature
          gpg --verify terraform-provider-opnsense_${VERSION}_SHA256SUMS.sig terraform-provider-opnsense_${VERSION}_SHA256SUMS
          \`\`\`
          
          ## ðŸ“– Documentation
          
          - [Complete Resources Reference](https://github.com/rgcosta7/terraform-provider-opnsense-26/blob/main/docs/ALL_RESOURCES_COMPLETE_REFERENCE.md)
          - [Examples](https://github.com/rgcosta7/terraform-provider-opnsense-26/tree/main/examples)
          - [Changelog](https://github.com/rgcosta7/terraform-provider-opnsense-26/blob/main/CHANGELOG.md)
          
          ## ðŸ› Issues
          
          Report issues: https://github.com/rgcosta7/terraform-provider-opnsense-26/issues
          EOF
          
          cat release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-trigger.outputs.version }}
          name: Release v${{ needs.check-trigger.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.check-trigger.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** Linux (amd64, arm64), macOS (amd64, arm64), Windows (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "**Signature:** Binary format (Terraform Registry compatible)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Files Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- 5 platform-specific ZIP files" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256SUMS checksum file" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256SUMS.sig signature file (binary format)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-trigger.outputs.version }})" >> $GITHUB_STEP_SUMMARY